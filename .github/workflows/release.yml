name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write
  id-token: write

jobs:
  release:
    name: Release
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: zodipus_test
          POSTGRES_PASSWORD: zodipus_test_password
          POSTGRES_DB: zodipus_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5433:5432

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24'
          cache: 'pnpm'
          registry-url: 'https://registry.npmjs.org'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Bootstrap Generator
        run: pnpm --filter zodipus build -- --no-dts

      - name: Generate Prisma Client
        run: |
          cd packages/zodipus
          pnpm exec prisma generate

      - name: Lint
        run: pnpm --filter zodipus lint

      - name: TypeScript check
        run: pnpm --filter zodipus typecheck

      - name: Build
        run: pnpm --filter zodipus build

      - name: Run migrations
        run: pnpm --filter zodipus db:migrate
        env:
          DATABASE_URL: postgresql://zodipus_test:zodipus_test_password@localhost:5433/zodipus_test?schema=public

      - name: Create .env.test
        run: |
          cd packages/zodipus
          echo "DATABASE_URL=postgresql://zodipus_test:zodipus_test_password@localhost:5433/zodipus_test?schema=public" > .env.test

      - name: Run tests
        run: pnpm --filter zodipus test
        env:
          DATABASE_URL: postgresql://zodipus_test:zodipus_test_password@localhost:5433/zodipus_test?schema=public

      - name: Extract version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Verify version matches package.json
        run: |
          PACKAGE_VERSION=$(node -p "require('./packages/zodipus/package.json').version")
          if [ "${{ steps.version.outputs.VERSION }}" != "$PACKAGE_VERSION" ]; then
            echo "Tag version (${{ steps.version.outputs.VERSION }}) doesn't match package.json version ($PACKAGE_VERSION)"
            exit 1
          fi

      - name: Publish to npm
        run: |
          cd packages/zodipus
          pnpm publish --access public --no-git-checks
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Generate Release Notes
        id: release_notes
        run: |
          # Get the previous tag
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          
          if [ -z "$PREV_TAG" ]; then
            # First release - get all commits
            COMMITS=$(git log --pretty=format:"- %s (%h)" --no-merges)
          else
            # Get commits since previous tag
            COMMITS=$(git log ${PREV_TAG}..HEAD --pretty=format:"- %s (%h)" --no-merges)
          fi
          
          # Save to file for GitHub release
          echo "## What's Changed" > release_notes.md
          echo "" >> release_notes.md
          echo "$COMMITS" >> release_notes.md
          echo "" >> release_notes.md
          echo "**Full Changelog**: https://github.com/${{ github.repository }}/compare/${PREV_TAG}...v${{ steps.version.outputs.VERSION }}" >> release_notes.md

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          body_path: release_notes.md
          generate_release_notes: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  notify:
    name: Notify
    runs-on: ubuntu-latest
    needs: release
    if: success()
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Extract version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Post release summary
        run: |
          echo "## ðŸŽ‰ Release v${{ steps.version.outputs.VERSION }} published!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- npm: https://www.npmjs.com/package/zodipus/v/${{ steps.version.outputs.VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "- GitHub: https://github.com/${{ github.repository }}/releases/tag/v${{ steps.version.outputs.VERSION }}" >> $GITHUB_STEP_SUMMARY
